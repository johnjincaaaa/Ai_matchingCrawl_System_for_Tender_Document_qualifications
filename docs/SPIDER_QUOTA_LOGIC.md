# 爬虫配额未满足时的处理逻辑

## 问题：所有城市轮完后配额未满足会怎样？

### 当前逻辑

**答案：不会继续爬取更早的文件，直接结束爬取。**

### 详细流程

当设置 `days_before=1` 时，假设配额是 100，但只爬取了 50 个项目：

#### 流程示例

1. **遍历政府类**
   - 浙江省本级：爬取今天和昨天的文件，遇到早于昨天的项目 → **停止该城市**
   - 杭州市：爬取今天和昨天的文件，遇到早于昨天的项目 → **停止该城市**
   - 宁波市：爬取今天和昨天的文件，遇到早于昨天的项目 → **停止该城市**
   - ...（所有12个城市都轮完）
   - 当前已爬取：50个项目
   - 配额未满足：还需要 50 个

2. **遍历非政府类**
   - 浙江省本级：爬取今天和昨天的文件，遇到早于昨天的项目 → **停止该城市**
   - 杭州市：爬取今天和昨天的文件，遇到早于昨天的项目 → **停止该城市**
   - ...（所有12个城市都轮完）
   - 当前已爬取：80个项目
   - 配额未满足：还需要 20 个

3. **所有分类和城市都遍历完毕**
   - ✅ **直接结束爬取**
   - ❌ **不会继续爬取前天的文件**
   - 最终爬取：80个项目（未达到100的配额）

### 代码逻辑

```python
# 外层循环：遍历分类
for category in self.category_codes:
    # 检查配额
    if total_count >= self.daily_limit:
        break  # 达到配额，停止
    
    # 内层循环：遍历城市
    for district_code, district_name in self.district_codes.items():
        # 检查配额
        if total_count >= self.daily_limit:
            break  # 达到配额，停止
        
        # 爬取该城市的项目
        while page_no <= max_pages and not found_non_today:
            for item in items:
                # 检查日期
                if project_date < earliest_date:
                    # 早于时间范围，停止该城市
                    found_non_today = True
                    break  # 只停止该城市，继续下一个城市
                
                # 在时间范围内，继续爬取
                # 保存项目...
        
        # 该城市爬取完成，继续下一个城市

# 所有城市都遍历完毕，结束
log.info(f"浙江省招标网爬取完成，总获取: {total_count}个项目")
```

### 关键点

1. **时间范围限制是硬性的**：
   - 当 `days_before=1` 时，时间范围固定在 `[昨天, 今天]`
   - 遇到早于昨天的项目时，**立即停止该城市**
   - **不会扩大时间范围**

2. **配额未满足也不会继续**：
   - 所有城市都轮完后，外层循环结束
   - **不会重新开始爬取更早的文件**
   - **不会扩大 `days_before` 的范围**

3. **设计原因**：
   - 优先爬取最新的项目（最近1-2天）
   - 避免爬取过时的项目
   - 配额限制是软性的，未满足也正常结束

### 示例场景

假设今天是 **2025-12-24**，设置 `days_before=1`，配额 `daily_limit=100`：

| 城市 | 今天的项目 | 昨天的项目 | 爬取结果 | 累计 |
|------|-----------|-----------|---------|------|
| 浙江省本级 | 5个 | 3个 | 爬取8个，遇到前天项目停止 | 8 |
| 杭州市 | 10个 | 5个 | 爬取15个，遇到前天项目停止 | 23 |
| 宁波市 | 8个 | 4个 | 爬取12个，遇到前天项目停止 | 35 |
| ... | ... | ... | ... | ... |
| 丽水市 | 2个 | 1个 | 爬取3个，遇到前天项目停止 | **80** |

**结果**：
- ✅ 爬取了 80 个项目
- ❌ 配额未满足（还需要 20 个）
- ❌ **不会继续爬取前天的文件**
- ✅ 直接结束

### 如果需要继续爬取更早的文件

如果希望配额未满足时继续爬取更早的文件，需要修改逻辑：

#### 方案1：扩大时间范围

修改 `days_before` 的值，例如从 1 改为 7，爬取最近7天的文件。

#### 方案2：修改代码逻辑（需要开发）

添加配额检查逻辑：
- 如果所有城市轮完后配额未满足
- 扩大时间范围（例如 `days_before` 从 1 扩大到 3）
- 重新开始爬取

但这需要修改代码实现，当前版本不支持。

### 总结

| 场景 | 是否会继续爬取 |
|------|--------------|
| 所有城市的今天和昨天文件都爬完，配额已满足 | ❌ 不会继续（已达到配额） |
| 所有城市的今天和昨天文件都爬完，配额未满足 | ❌ 不会继续（时间范围限制） |
| 某个城市遇到早于时间范围的项目 | ❌ 停止该城市，继续下一个城市 |
| 达到配额限制 | ❌ 立即停止所有爬取 |

**当前设计的核心思想**：
- 优先爬取最新项目（最近1-2天）
- 时间范围限制是硬性的，不会因为配额未满足而扩大
- 配额是目标值，未完全满足也正常

---

**最后更新时间**：2025-12-24

