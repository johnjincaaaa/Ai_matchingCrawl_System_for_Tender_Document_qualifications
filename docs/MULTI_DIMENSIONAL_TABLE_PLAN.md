# 项目多维表格功能方案

## 一、功能概述

创建一个功能强大的项目多维表格系统，支持：
- 📋 项目信息快速浏览
- 📄 采购需求预览和打开
- 📊 评分表预览和打开
- 📎 招标文件预览和下载
- 🔍 智能筛选和搜索
- 📈 数据统计和分析

## 二、核心功能需求

### 2.1 表格展示功能

#### 2.1.1 基础信息列
- **项目ID**：唯一标识
- **项目名称**：完整项目名称
- **发布时间**：格式化为易读日期
- **所属区域**：省/市/区县
- **采购类型**：政府采购/国企采购
- **招标方式**：最低价中标/综合评分法等
- **项目状态**：待处理/已下载/已解析/已分析/已比对/异常
- **最终判定**：推荐参与/不推荐参与/未判定

#### 2.1.2 客观分信息列
- **客观分总满分**：数值显示
- **客观分可得分**：数值显示，颜色标识（绿色=满分，黄色=部分，红色=不满分）
- **客观分失分**：数值显示
- **客观分条目数**：共X项
- **客观分得分率**：百分比显示，进度条可视化

#### 2.1.3 操作列
- **采购需求**：预览按钮（弹窗显示）+ 打开按钮（新标签页）
- **评分表**：预览按钮（弹窗显示）+ 打开按钮（新标签页）
- **招标文件**：预览按钮（在线预览）+ 下载按钮
- **详细分析**：查看完整比对结果

### 2.2 文件预览功能

#### 2.2.1 采购需求预览
- **弹窗预览**：在表格页面直接弹窗显示
  - 显示提取的 `project_requirements` 字段内容
  - 支持文本搜索和高亮
  - 支持复制文本
  - 支持格式化显示（Markdown渲染）
- **新标签页打开**：在新标签页显示完整内容
  - 支持打印
  - 支持导出为PDF/Word

#### 2.2.2 评分表预览
- **弹窗预览**：显示 `evaluation_content` 字段
  - 表格格式化显示
  - 支持主客观分分类显示
  - 支持客观分条目展开/折叠
- **新标签页打开**：完整评分表内容
  - 支持导出

#### 2.2.3 招标文件预览和下载
- **在线预览**：
  - DOC/DOCX文件：使用在线文档预览服务（如OnlyOffice、Office Online）
  - PDF文件：使用PDF.js直接预览
  - 图片文件：直接显示
- **下载功能**：
  - 支持直接下载原始文件
  - 支持批量下载（选中多个项目）
  - 下载进度显示

### 2.3 智能筛选功能

#### 2.3.1 基础筛选
- **时间范围筛选**：
  - 发布时间：日期选择器（开始日期-结束日期）
  - 快捷选项：今天/最近7天/最近30天/本月/本季度/自定义
- **区域筛选**：
  - 多选下拉框：省/市/区县
  - 支持搜索
  - 支持全选/反选
- **采购类型筛选**：
  - 单选/多选：政府采购、国企采购
- **项目状态筛选**：
  - 多选：待处理/已下载/已解析/已分析/已比对/异常
- **最终判定筛选**：
  - 单选/多选：推荐参与/不推荐参与/未判定

#### 2.3.2 客观分筛选
- **客观分总满分范围**：
  - 数值范围滑块：最小值-最大值
  - 快捷选项：0-20分/21-40分/41-60分/61-80分/81-100分
- **客观分可得分范围**：
  - 数值范围滑块
- **客观分得分率筛选**：
  - 百分比范围滑块
  - 快捷选项：满分（100%）/高分（80-99%）/中等（50-79%）/低分（<50%）
- **客观分失分筛选**：
  - 失分=0（满分）/失分≤1分/失分≤5分/失分>5分

#### 2.3.3 高级筛选
- **关键词搜索**：
  - 项目名称搜索：模糊匹配
  - 采购需求内容搜索：全文搜索
  - 评分表内容搜索：全文搜索
- **组合筛选**：
  - 支持多个筛选条件组合（AND/OR逻辑）
  - 保存筛选方案（常用筛选条件）
  - 筛选历史记录

#### 2.3.4 智能推荐筛选
- **推荐参与项目**：自动筛选所有推荐参与的项目
- **高分项目**：客观分得分率≥80%的项目
- **近期项目**：最近7天发布的项目
- **待处理项目**：状态为待处理的项目
- **异常项目**：状态为异常的项目

### 2.4 数据统计功能

#### 2.4.1 顶部统计卡片
- **总项目数**：当前筛选条件下的项目总数
- **推荐参与数**：推荐参与的项目数量
- **平均客观分得分率**：当前项目的平均得分率
- **今日新增**：今天新增的项目数量

#### 2.4.2 图表统计
- **项目状态分布**：饼图
- **区域分布**：柱状图/地图
- **客观分得分率分布**：直方图
- **时间趋势**：折线图（按日期统计项目数量）

## 三、技术架构方案

### 3.1 前端技术栈

#### 3.1.1 表格组件
- **主表格库**：AG-Grid 或 Ant Design Table
  - 支持虚拟滚动（处理大量数据）
  - 支持列排序、筛选、固定列
  - 支持行选择、批量操作
  - 支持导出Excel/CSV

#### 3.1.2 UI框架
- **基础框架**：Streamlit（当前使用）或 React + Ant Design
- **弹窗组件**：Ant Design Modal 或自定义Modal
- **文件预览**：
  - PDF：react-pdf 或 PDF.js
  - Office文档：OnlyOffice Document Server（推荐）或 Office Online
  - 图片：直接img标签

#### 3.1.3 状态管理
- **筛选状态**：React Context 或 Redux（如果使用React）
- **表格状态**：组件内部状态 + URL参数（支持分享筛选链接）

### 3.2 后端技术栈

#### 3.2.1 API设计
```python
# 项目列表API
GET /api/projects
Query Parameters:
  - page: 页码
  - page_size: 每页数量
  - start_date: 开始日期
  - end_date: 结束日期
  - regions: 区域列表（逗号分隔）
  - status: 状态列表
  - final_decision: 最终判定
  - objective_score_min: 客观分最小值
  - objective_score_max: 客观分最大值
  - keyword: 关键词搜索
  - sort_by: 排序字段
  - sort_order: 排序方向（asc/desc）

Response:
{
  "total": 1000,
  "page": 1,
  "page_size": 50,
  "data": [...],
  "statistics": {
    "total_count": 1000,
    "recommended_count": 500,
    "avg_score_rate": 0.85
  }
}
```

#### 3.2.2 文件服务
```python
# 文件预览API
GET /api/files/{project_id}/preview
Response: 文件内容（文本）或预览URL

# 文件下载API
GET /api/files/{project_id}/download
Response: 文件流下载
```

### 3.3 数据库优化

#### 3.3.1 索引优化
```sql
-- 为常用筛选字段创建索引
CREATE INDEX idx_publish_time ON tender_projects(publish_time);
CREATE INDEX idx_region ON tender_projects(region);
CREATE INDEX idx_status ON tender_projects(status);
CREATE INDEX idx_final_decision ON tender_projects(final_decision);
CREATE INDEX idx_project_name ON tender_projects(project_name);
```

#### 3.3.2 查询优化
- 使用分页查询，避免一次性加载所有数据
- 使用数据库视图预计算统计信息
- 使用缓存（Redis）缓存常用查询结果

## 四、UI/UX设计

### 4.1 页面布局

```
┌─────────────────────────────────────────────────────────┐
│  顶部导航栏                                              │
├─────────────────────────────────────────────────────────┤
│  [统计卡片区域]                                          │
│  ┌──────┐ ┌──────┐ ┌──────┐ ┌──────┐                    │
│  │总项目│ │推荐数│ │平均分│ │今日新│                    │
│  │ 1000 │ │ 500  │ │ 85%  │ │  10  │                    │
│  └──────┘ └──────┘ └──────┘ └──────┘                    │
├─────────────────────────────────────────────────────────┤
│  [筛选工具栏]                                            │
│  [时间] [区域▼] [状态▼] [判定▼] [客观分▼] [搜索框] [重置]│
├─────────────────────────────────────────────────────────┤
│  [表格区域]                                              │
│  ┌───────────────────────────────────────────────────┐ │
│  │ ☑ │ ID │ 项目名称 │ 发布时间 │ ... │ 操作 │      │ │
│  ├───┼────┼──────────┼──────────┼─────┼──────┤      │ │
│  │ ☐ │ 1  │ 项目A   │ 2024-01-01│ ... │ [预览]│      │ │
│  │ ☐ │ 2  │ 项目B   │ 2024-01-02│ ... │ [预览]│      │ │
│  └───────────────────────────────────────────────────┘ │
│  [分页控件] [1] [2] [3] ... [20]                        │
└─────────────────────────────────────────────────────────┘
```

### 4.2 弹窗预览设计

```
┌─────────────────────────────────────────────┐
│  采购需求预览                          [×]   │
├─────────────────────────────────────────────┤
│  [搜索框] [复制] [导出] [打印]              │
├─────────────────────────────────────────────┤
│                                              │
│  项目名称：XXX项目                           │
│                                              │
│  采购需求内容：                              │
│  ...                                         │
│                                              │
│                                              │
├─────────────────────────────────────────────┤
│  [在新标签页打开] [关闭]                     │
└─────────────────────────────────────────────┘
```

### 4.3 响应式设计
- **桌面端**：完整功能，多列显示
- **平板端**：简化列，支持横向滚动
- **移动端**：卡片式布局，详情页展示

## 五、实现步骤

### 5.1 第一阶段：基础表格功能（1-2周）
1. ✅ 创建项目列表API
2. ✅ 实现基础表格展示
3. ✅ 实现基础筛选功能（时间、区域、状态）
4. ✅ 实现分页功能

### 5.2 第二阶段：文件预览功能（1-2周）
1. ✅ 实现采购需求预览弹窗
2. ✅ 实现评分表预览弹窗
3. ✅ 集成文件预览服务（PDF.js、OnlyOffice）
4. ✅ 实现文件下载功能

### 5.3 第三阶段：高级筛选功能（1周）
1. ✅ 实现客观分筛选
2. ✅ 实现关键词搜索
3. ✅ 实现组合筛选
4. ✅ 实现筛选方案保存

### 5.4 第四阶段：统计和优化（1周）
1. ✅ 实现统计卡片
2. ✅ 实现图表统计
3. ✅ 性能优化（虚拟滚动、缓存）
4. ✅ 用户体验优化

## 六、技术细节

### 6.1 文件预览方案

#### 6.1.1 PDF预览
```python
# 使用PDF.js
# 前端：react-pdf 或 pdfjs-dist
# 后端：直接返回PDF文件流
```

#### 6.1.2 Office文档预览
```python
# 方案1：OnlyOffice Document Server（推荐）
# - 开源、功能强大
# - 支持DOC/DOCX/XLS/XLSX/PPT/PPTX
# - 需要部署Document Server

# 方案2：Office Online（Microsoft）
# - 需要Office 365订阅
# - 功能完整但需要授权

# 方案3：LibreOffice + 转换为PDF
# - 服务器端转换
# - 然后使用PDF预览
```

#### 6.1.3 文本内容预览
```python
# 对于已提取的文本内容（project_requirements, evaluation_content）
# 直接在前端显示，支持Markdown渲染
```

### 6.2 筛选性能优化

#### 6.2.1 数据库查询优化
```python
# 使用索引
# 使用分页
# 使用数据库视图预计算
# 使用缓存
```

#### 6.2.2 前端优化
```python
# 虚拟滚动
# 防抖搜索
# 筛选条件缓存
# 懒加载
```

### 6.3 数据导出功能

```python
# 支持导出Excel
# 支持导出CSV
# 支持导出PDF报告
# 支持批量下载文件
```

## 七、数据库设计

### 7.1 新增表结构（如需要）

```sql
-- 筛选方案表
CREATE TABLE filter_presets (
    id SERIAL PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    user_id INTEGER,
    filter_config JSONB NOT NULL,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- 项目统计视图（预计算）
CREATE VIEW project_statistics AS
SELECT 
    COUNT(*) as total_count,
    COUNT(CASE WHEN final_decision = '推荐参与' THEN 1 END) as recommended_count,
    AVG(objective_score_rate) as avg_score_rate
FROM tender_projects
WHERE status = '已比对';
```

## 八、API接口设计

### 8.1 项目列表接口

```python
@app.get("/api/projects")
async def get_projects(
    page: int = 1,
    page_size: int = 50,
    start_date: Optional[datetime] = None,
    end_date: Optional[datetime] = None,
    regions: Optional[str] = None,  # 逗号分隔
    status: Optional[str] = None,   # 逗号分隔
    final_decision: Optional[str] = None,
    objective_score_min: Optional[float] = None,
    objective_score_max: Optional[float] = None,
    keyword: Optional[str] = None,
    sort_by: str = "publish_time",
    sort_order: str = "desc"
):
    """
    获取项目列表
    """
    # 实现查询逻辑
    pass
```

### 8.2 文件预览接口

```python
@app.get("/api/projects/{project_id}/requirements")
async def get_project_requirements(project_id: int):
    """
    获取项目采购需求
    """
    pass

@app.get("/api/projects/{project_id}/evaluation")
async def get_project_evaluation(project_id: int):
    """
    获取项目评分表
    """
    pass

@app.get("/api/projects/{project_id}/file/preview")
async def preview_file(project_id: int):
    """
    预览招标文件
    """
    pass

@app.get("/api/projects/{project_id}/file/download")
async def download_file(project_id: int):
    """
    下载招标文件
    """
    pass
```

## 九、性能指标

### 9.1 目标性能
- **页面加载时间**：< 2秒（首次加载）
- **筛选响应时间**：< 500ms
- **文件预览加载**：< 3秒
- **支持数据量**：10万+项目

### 9.2 优化措施
- 数据库索引优化
- 查询结果缓存
- 前端虚拟滚动
- 文件CDN加速
- 异步加载

## 十、安全考虑

### 10.1 文件安全
- 文件下载权限控制
- 文件预览权限控制
- 防止路径遍历攻击
- 文件类型验证

### 10.2 数据安全
- SQL注入防护
- XSS防护
- CSRF防护
- 敏感信息脱敏

## 十一、后续扩展功能

### 11.1 高级功能
- **项目对比**：选择多个项目进行对比
- **项目收藏**：收藏感兴趣的项目
- **项目标签**：自定义标签分类
- **项目备注**：添加个人备注

### 11.2 数据分析
- **趋势分析**：项目数量趋势
- **区域分析**：各区域项目分布
- **得分分析**：客观分得分分布
- **竞标建议**：基于历史数据的建议

### 11.3 协作功能
- **项目分享**：分享项目链接
- **团队协作**：多人协作分析
- **评论功能**：项目评论和讨论

## 十二、技术选型建议

### 12.1 如果继续使用Streamlit
- **优点**：快速开发，Python后端
- **缺点**：UI定制性有限，性能可能受限
- **建议**：使用Streamlit的DataFrame和AgGrid组件

### 12.2 如果迁移到React
- **优点**：UI灵活，性能好，用户体验佳
- **缺点**：开发工作量大，需要前后端分离
- **建议**：使用Ant Design + AG-Grid + React Query

### 12.3 混合方案
- **后端**：FastAPI（Python）
- **前端**：React + Ant Design
- **文件预览**：OnlyOffice Document Server
- **数据库**：PostgreSQL（当前）

## 十三、开发优先级

### P0（必须实现）
1. ✅ 基础表格展示
2. ✅ 基础筛选功能
3. ✅ 文件预览功能
4. ✅ 文件下载功能

### P1（重要）
1. ✅ 客观分筛选
2. ✅ 关键词搜索
3. ✅ 统计卡片
4. ✅ 分页功能

### P2（可选）
1. ⬜ 筛选方案保存
2. ⬜ 图表统计
3. ⬜ 批量操作
4. ⬜ 数据导出

## 十四、总结

本方案提供了一个完整的多维表格功能实现方案，包括：
- 📋 完整的表格展示功能
- 📄 文件预览和下载功能
- 🔍 强大的筛选和搜索功能
- 📈 数据统计和分析功能
- ⚡ 性能优化方案
- 🔒 安全考虑

建议采用分阶段实施的方式，先实现核心功能，再逐步完善高级功能。

